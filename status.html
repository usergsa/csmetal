<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coletor</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00d4ff;
            --secondary: #7c3aed;
            --accent: #ff0080;
            --dark: #0a0f1c;
            --dark-secondary: #1a1f2e;
            --dark-tertiary: #242938;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff4757;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(120deg,#e3eaf2 60%,#f0f4f8 100%);
            margin: 0;
            padding: 24px;
            color: #222;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(255, 0, 128, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0;
            gap: 0.5rem;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            margin-bottom: 0.5rem;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.2rem;
            color: #1976d2;
            background: none;
            -webkit-text-fill-color: unset;
        }

        .controls {
            text-align: center;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1rem;
            border-radius: 14px;
            background: #f7fafd;
            box-shadow: none;
            border: 1.5px solid #e3eaf2;
        }

        .input-group {
            min-width: 140px;
            margin-right: 0.5rem;
        }

        #nomePlanilhaInput {
            padding: 8px;
            border-radius: 8px;
            font-size: 15px;
            border: 1.5px solid #bdbdbd;
            background: #f7fafd;
            transition: border-color 0.2s;
        }

        #nomePlanilhaInput:focus {
            border-color: #1976d2;
            background: #e3eaf2;
        }

        .btn, .btn-export {
            padding: 8px 18px;
            border-radius: 8px;
            font-size: 15px;
            margin: 0;
            background: linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);
            color: #fff;
            border: none;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(25,118,210,0.08);
            transition: background 0.2s, box-shadow 0.2s;
        }

        .btn-export {
            background: linear-gradient(90deg,#00ff88 60%,#00cc7a 100%);
            color: #fff;
        }

        .btn:hover, .btn-export:hover {
            background: linear-gradient(90deg,#125ea7 60%,#1976d2 100%);
            box-shadow: 0 4px 16px rgba(25,118,210,0.12);
        }

        .botoes-container {
            margin-bottom: 0.5rem;
            border-radius: 10px;
            background: #f7fafd;
            border: 1.5px solid #e3eaf2;
        }

        .botoes-scroll {
            gap: 0.5rem;
            padding: 0.7rem 0.5rem;
            display: flex;
            overflow-x: auto;
        }

        .btn-planilha {
            padding: 8px 16px;
            border-radius: 7px;
            font-size: 15px;
            margin: 0;
            background: #e3eaf2;
            color: #1976d2;
            border: 1.5px solid #bdbdbd;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }

        .btn-planilha:hover {
            background: #1976d2;
            color: #fff;
            border-color: #1976d2;
        }

        .list-container {
            max-width: 98%;
            margin: 0 auto;
            border: 1.5px solid #e3eaf2;
            border-radius: 12px;
            background: #fff;
            max-height: 75vh;
            overflow-y: auto;
            box-shadow: 0 4px 24px rgba(25,118,210,0.08);
            margin-top: 0.5rem;
        }

        .table-wrapper {
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        thead {
            background: #1976d2;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 2;
            font-size: 16px;
            letter-spacing: 0.5px;
        }

        th, td {
            padding: 10px 14px;
            border-bottom: 1px solid #eee;
            text-align: left;
            white-space: nowrap;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        tr:hover td {
            background: #e3eaf2;
            transition: background 0.2s;
        }

        .status {
            text-align: center;
            margin: 12px;
            font-size: 15px;
            color: #555;
            background: #f7fafd;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(25,118,210,0.04);
        }

        .empty-state {
            font-size: 1rem;
            height: 180px;
            padding: 0.5rem;
            color: #1976d2;
            background: #f7fafd;
            border-radius: 8px;
        }

        .empty-state::before {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            content: 'üìã';
            display: block;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            .controls {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            .list-container {
                max-height: 60vh;
            }
            .table-wrapper {
                padding: 0.5rem 0.2rem;
            }
            th, td {
                padding: 0.4rem 0.2rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <div class="controls">
            <div class="input-group">
                <input type="text" id="nomePlanilhaInput" placeholder="Nome do cliente">
            </div>
            <button class="btn" onclick="onCarregarClick()">
                <div class="glow"></div>
                üöÄ Carregar
            </button>
            <button class="btn btn-export" onclick="exportarExcel()">
                <div class="glow"></div>
                üì§ Exportar
            </button>
            <div class="botoes-container">
            <div class="botoes-scroll" id="botoes-planilhas">
                <!-- Bot√µes das planilhas ser√£o inseridos aqui -->
            </div>
        </div>
        </div>

        

        <div class="list-container">
            <div class="table-wrapper">
                <table>
                    <thead id="flatListHeader"></thead>
                    <tbody id="flatList"></tbody>
                </table>
            </div>
        </div>

        <div class="status" id="statusMsg">‚è∏Ô∏è Monitor parado</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let ultimaLista = [];
        let headersAtuais = [];
        let monitorInterval = null;
        let planilhaAtual = null;

        const ordemCabecalhos = ["data", "marca", "qtdp", "endereco","id", "cliente", "pendente"];

        function extrairDados(rows, headers) {
            if (!Array.isArray(rows) || !headers?.length) return [];
            return rows.map(item => {
                if (typeof item === 'object' && !Array.isArray(item)) return item;
                const obj = {};
                headers.forEach((h, i) => { if (h) obj[h] = item[i]; });
                return obj;
            });
        }

        function formatarData(dt) {
            if (!dt) return "";
            const d = new Date(dt);
            if (isNaN(d.getTime())) return dt;
            return d.toLocaleString("pt-BR", { 
                day: "2-digit", 
                month: "2-digit", 
                year: "numeric", 
                hour: "2-digit", 
                minute: "2-digit" 
            });
        }

        function renderHeader(headers) {
            const thead = document.getElementById('flatListHeader');
            if (!headers || !headers.length) {
                thead.innerHTML = '';
                headersAtuais = [];
                return;
            }
            // Filtra e exibe apenas os cabe√ßalhos presentes na ordem definida
            const filteredHeaders = ordemCabecalhos.filter(h => headers.includes(h));
            thead.innerHTML = `<tr>${filteredHeaders.map(h => `<th>${String(h).toUpperCase()}</th>`).join('')}</tr>`;
            headersAtuais = filteredHeaders;
        }

        function renderItem(item) {
            const tr = document.createElement('tr');
            tr.innerHTML = headersAtuais.map(h => {
                let val = item[h] ?? '';
                if (String(h).toLowerCase() === "data") val = formatarData(val);
                return `<td>${val}</td>`;
            }).join('');
            return tr;
        }

        function FlatList({ data }) {
            const tbody = document.getElementById('flatList');
            tbody.innerHTML = '';
            if (!data.length) {
                renderHeader(ordemCabecalhos); // fallback
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${ordemCabecalhos.length}" style="text-align:center; padding: 3rem;">
                            <div class="empty-state">
                                Aguardando dados da planilha...
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            // Descobre os headers reais presentes nos dados
            const headers = Object.keys(data[0]);
            renderHeader(headers);
            data.forEach(item => tbody.appendChild(renderItem(item)));
        }

        async function exibirPlanilha(nomePlanilha) {
            const tbody = document.getElementById('flatList');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${ordemCabecalhos.length}" style="text-align:center; padding: 3rem;">
                            <div class="empty-state">
                                ‚è≥ Carregando dados...
                            </div>
                        </td>
                    </tr>
                `;
            }
            const resultado = await carregarPlanilha(nomePlanilha);
            if (!resultado || !Array.isArray(resultado.rows) || !resultado.rows.length) {
                ultimaLista = [];
                FlatList({ data: [] });
                return;
            }
            const lista = extrairDados(resultado.rows, resultado.headers || []);
            ultimaLista = lista;
            FlatList({ data: lista });
        }

        function iniciarMonitor(nomePlanilha) {
            if (monitorInterval) clearInterval(monitorInterval);
            monitorInterval = setInterval(async () => {
                const resultado = await carregarPlanilha(nomePlanilha);
                if (!resultado) {
                    ultimaLista = [];
                    FlatList({ data: [] });
                    return;
                }
                const novaLista = extrairDados(resultado.rows, resultado.headers || []);
                if (JSON.stringify(novaLista) !== JSON.stringify(ultimaLista)) {
                    ultimaLista = novaLista;
                    FlatList({ data: novaLista });
                    document.getElementById('statusMsg').textContent = `‚úÖ Atualizado em ${new Date().toLocaleTimeString()}`;
                } else {
                    document.getElementById('statusMsg').textContent = `‚è≥ Nenhuma mudan√ßa (${new Date().toLocaleTimeString()})`;
                }
            }, 5000);
            document.getElementById('statusMsg').textContent = "‚ñ∂Ô∏è Monitor ativo";
        }

        function onCarregarClick() {
            const nomePlanilha = document.getElementById('nomePlanilhaInput').value.trim();
            if (!nomePlanilha) return;
            planilhaAtual = nomePlanilha;
            exibirPlanilha(planilhaAtual);
            iniciarMonitor(planilhaAtual);
        }

        function exportarExcel() {
            if (!ultimaLista.length || !headersAtuais.length) {
                alert("Nenhum dado para exportar.");
                return;
            }
            const wsData = [headersAtuais];
            ultimaLista.forEach(row => {
                const linha = headersAtuais.map(h => {
                    if (h === "data") return formatarData(row[h]);
                    return row[h] ?? "";
                });
                wsData.push(linha);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, `planilha_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        async function carregarPlanilha(nomePlanilha) {
            if (!nomePlanilha) return null;
            const url = `https://script.google.com/macros/s/AKfycbwajXGwggwzHO0I-97Q3_9Kdn2NZnV-VhvsxRsCgdD1gzn9qvtj8Ut2AiY8dbJxQsgNOA/exec?plan=${encodeURIComponent(nomePlanilha)}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const dados = await response.json();
                if (dados.status !== "success" || !Array.isArray(dados.rows)) throw new Error("Resposta inv√°lida da API");
                return dados;
            } catch {
                return null;
            }
        }

        // Fun√ß√£o para listar planilhas e criar bot√µes
        async function listarPlanilhas() {
            const url = "https://script.google.com/macros/s/AKfycbwajXGwggwzHO0I-97Q3_9Kdn2NZnV-VhvsxRsCgdD1gzn9qvtj8Ut2AiY8dbJxQsgNOA/exec?action=listSheets";
            try {
                const response = await fetch(url);
                const json = await response.json();
                if (json.status === "success" && Array.isArray(json.sheets)) {
                    renderBotoesPlanilhas(json.sheets);
                }
            } catch (e) {
                document.getElementById("botoes-planilhas").innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 1rem;">
                        ‚ö†Ô∏è Erro ao carregar planilhas
                    </div>
                `;
            }
        }

        // Monitoramento autom√°tico das planilhas (atualiza bot√µes a cada 10s)
        let monitorPlanilhasInterval = null;
        function iniciarMonitorPlanilhas() {
            if (monitorPlanilhasInterval) clearInterval(monitorPlanilhasInterval);
            monitorPlanilhasInterval = setInterval(() => {
                listarPlanilhas();
            }, 10000); // 10 segundos
        }

        function renderBotoesPlanilhas(sheets) {
            const div = document.getElementById("botoes-planilhas");
            div.innerHTML = "";
            sheets.forEach(nome => {
                const bt = document.createElement("button");
                bt.className = "btn-planilha";
                bt.innerHTML = `
                    <div class="glow"></div>
                    ${nome}
                `;
                bt.onclick = () => {
                    document.getElementById('nomePlanilhaInput').value = nome;
                    planilhaAtual = nome;
                    exibirPlanilha(nome);
                    iniciarMonitor(nome);
                };
                div.appendChild(bt);
            });
        }

        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', () => {
            const plan = getQueryParam('plan');
            if (plan) {
                document.getElementById('nomePlanilhaInput').value = plan;
                exibirPlanilha(plan);
                iniciarMonitor(plan);
            }
            listarPlanilhas();
            iniciarMonitorPlanilhas();
        });
    </script>
</body>
</html>
